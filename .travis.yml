language: minimal
os: linux
dist: xenial
group: stable
sudo: required
git:
  depth: false
env:
  global:
    - ANDROID_API_LEVEL=29
    - ANDROID_BUILD_TOOLS_VERSION=29.0.2
    # For updates check developer.android.com/studio#downloads (current 26.1.1)
    - ANDROID_SDK_TOOLS=sdk-tools-linux-4333796.zip
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache/

stages:
  - name: Build debug
    if: branch IN (develop, master)
  - name: Build and deploy release on tags
    if: tag IS present

android_phases:
  - phase: &before_install
      # check if OpenJDK8 is installed and install if missing
      - if ! dpkg -s openjdk-8-jdk >/dev/null 2>&1; then sudo apt-get update; sudo apt-get install openjdk-8-jdk; fi
      - java -version
      # print available java versions with their path (must contain java-8-openjdk-amd64)
      - sudo update-alternatives --config java
      # set JAVA_HOME path
      - export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
      # download und unzip Android SDK Tools
      - wget -q https://dl.google.com/android/repository/$ANDROID_SDK_TOOLS
      - unzip -q $ANDROID_SDK_TOOLS -d $HOME/sdk
      # set SDK Tools path variable and ANDROID_HOME
      - export PATH=$PATH:$HOME/sdk/tools/bin
      - export ANDROID_HOME=$HOME/sdk
      # create empty cfg file to prevent sdkmanager warning message
      - mkdir -p $HOME/.android && touch $HOME/.android/repositories.cfg
  - phase: &install
      # latest SDK Platform-Tools
      - yes | sdkmanager "platform-tools" >/dev/null
      # defined SDK Platform
      - yes | sdkmanager "platforms;android-$ANDROID_API_LEVEL" >/dev/null
      # defined SDK Build-Tools
      - yes | sdkmanager "build-tools;$ANDROID_BUILD_TOOLS_VERSION" >/dev/null
      # list installed and available packages
      - sdkmanager --list
  - phase: &before_script
      # set executable flag for gradle wrapper
      - chmod +x gradlew
      # create dir for gradle settings
      - mkdir -p $HOME/.gradle
      # disable gradle daemon for current user
      - echo "org.gradle.daemon=false" >> $HOME/.gradle/gradle.properties
      # set gradle log format to plain
      - echo "org.gradle.console=plain" >> $HOME/.gradle/gradle.properties
      # enable gradle build cache
      - echo "org.gradle.caching=true" >> $HOME/.gradle/gradle.properties
      # log all gradle warnings
      - echo "org.gradle.warning.mode=all" >> $HOME/.gradle/gradle.properties
  - phase: &before_cache
      - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
      - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
      - rm -f  $HOME/.gradle/caches/*/fileHashes/fileHashes.bin
      - rm -f  $HOME/.gradle/caches/*/fileHashes/fileHashes.lock
      - rm -f  $HOME/.gradle/caches/*/javaCompile/javaCompile.lock
      - rm -f  $HOME/.gradle/caches/*/executionHistory/executionHistory.lock
      - rm -f  $HOME/.gradle/caches/journal-1/file-access.bin
      - rm -f  $HOME/.gradle/caches/journal-1/journal-1.lock
      - rm -f  $HOME/.gradle/caches/transforms-1/transforms-1.lock
      - rm -f  $HOME/.gradle/caches/user-id.txt.lock
      # only cache last gradle version used by the wrapper
      # list content in wrapper/dist sorted by modification time and remove entries starting by the second entry
      - ls -d $HOME/.gradle/wrapper/dists/* -1t | tail -n +2 | xargs rm -rf
  - phase: &deploy
      provider: releases
      api_key:
        secure: ppFVN1NWsqXYYWtekUlrbrZOZljenepblTIrdn73uVffFaY9EaNFBLuOFPLTAzxVdKjJVv0uKpZ23sDck1IG7vp13hAeeXWocb8YkJrxRO8DEKPHC+GHRolfm33EjcdL0Y54mAJzgcLTwZeMsJUdRhdjp02h+QwqUPnx+0FlaIuUhhNm9jdzMb+EJlhWQevKtMuOhuT9ByAtHieSjyY9i0romBxzFkCj/j5a8RMCrMbXwB/Y7eX0KywmXd/XLh2wauuix7L7gcbKxI/r/mNUyN32Q2HCtckyor8o+0rx4GHV1eD+KslnfqyZZATTiGht+gZqfVC++v1bgEKrPGs72k4EEkpZcwuF5t0RwfV1aNg+zhn6tKWCHz9Kjgq7XcTmFb64avx/waWQmZpsmuG5TKe4iGG/6mboQmAMBP8Iy2x7auv7/3YXVaE1yigKgIZ0QtI4nMwpfHLX0XiKljXw9oH0LWiNGE20ldKue81ZDT+R9Lk2ir4lzV7equwys+K9wtbCiolElkHoAg1gBj7jr6iF1ezQAWm2M5jpfm16VysjIikr5GOU+bZGhlWYWJbsPg46Sh8oP56wiWWT+4Hka+yGRLonX2c0oltxVfxHkOSlOnXmypd6y1e6J18LrtRzELDY3vgXVCv/oiQWuzrKueQMq2VyZQlCyOKEMqg4w1s=
      file_glob: true
      file:
        - $TRAVIS_BUILD_DIR/app/build/outputs/apk/release/*.apk
        - $TRAVIS_BUILD_DIR/app/build/outputs/mapping/release/mapping.txt
      skip_cleanup: true
      draft: false
      on:
        repo: fso13/dnd5-android
        tags: true
      name: $TRAVIS_TAG
      tag_name: $TRAVIS_TAG
      body: "Generated release from Travis CI for build $TRAVIS_BUILD_NUMBER"

jobs:
  include:
    - stage: Build debug
      before_install: *before_install
      install: *install
      before_script: *before_script
      script: "./gradlew assembleDebug --scan"
      before_cache: *before_cache
    - stage: Build and deploy release on tags
      before_install: *before_install
      install: *install
      before_script: *before_script
      script: "./gradlew assembleRelease --scan"
      before_cache: *before_cache
      deploy: *deploy